<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Show Management ‚Äî Salt All The Things</title>
  <link rel="icon" type="image/jpeg" href="images/256x256.jpeg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* ===== Page-specific styles ===== */
    .ideas-grid { display: grid; grid-template-columns: 380px 1fr; gap: var(--space-lg); }
    @media (max-width: 1024px) { .ideas-grid { grid-template-columns: 1fr; } }
    .idea-composer { position: sticky; top: 80px; }
    .ideas-list { display: flex; flex-direction: column; gap: var(--space-md); }
    .idea-list-card {
      background: var(--bg-card); border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg); padding: var(--space-lg);
      cursor: pointer; transition: all var(--transition-default);
    }
    .idea-list-card:hover { border-color: var(--border-default); box-shadow: var(--shadow-card); }
    .idea-list-card.expanded { border-color: var(--gold-dim); }
    .idea-list-card .idea-header { display: flex; align-items: flex-start; justify-content: space-between; gap: var(--space-md); }
    .idea-expanded-content { display: none; margin-top: var(--space-lg); padding-top: var(--space-lg); border-top: 1px solid var(--border-subtle); }
    .idea-list-card.expanded .idea-expanded-content { display: block; }
    .title-option {
      display: flex; align-items: center; gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md); background: var(--bg-surface);
      border: 1px solid var(--border-subtle); border-radius: var(--radius-md);
      cursor: pointer; transition: all var(--transition-fast);
    }
    .title-option:hover { border-color: var(--border-default); }
    .title-option.selected { border-color: var(--gold); background: var(--gold-glow); }
    .title-option input[type="radio"] { accent-color: var(--gold); }
    .outline-segment { margin-bottom: var(--space-md); }
    .outline-segment h4 { font-size: 0.85rem; color: var(--ice-bright); margin-bottom: var(--space-xs); }
    .outline-segment ul { list-style: none; padding-left: var(--space-md); }
    .outline-segment li { position: relative; padding: var(--space-xs) 0; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5; }
    .outline-segment li::before { content: '‚Ä∫'; position: absolute; left: -14px; color: var(--gold-dim); font-weight: bold; }

    .schedule-layout { display: grid; grid-template-columns: 280px 1fr; gap: var(--space-lg); align-items: start; }
    @media (max-width: 1024px) { .schedule-layout { grid-template-columns: 1fr; } }
    .idea-bank { position: sticky; top: 80px; max-height: calc(100vh - 120px); overflow-y: auto; }
    .idea-bank-header {
      font-family: 'Cinzel', serif; font-size: 0.85rem; color: var(--text-gold);
      text-transform: uppercase; letter-spacing: 1px;
      padding-bottom: var(--space-sm); border-bottom: 1px solid var(--border-subtle); margin-bottom: var(--space-md);
    }
    .bank-ideas { display: flex; flex-direction: column; gap: var(--space-sm); }
    .bank-empty { text-align: center; padding: var(--space-xl) var(--space-md); color: var(--text-muted); font-size: 0.85rem; font-style: italic; }

    .calendar-container { background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: var(--space-lg); }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; }
    .calendar-day.tuesday { min-height: 160px; border-radius: var(--radius-md); }
    .tuesday-drop {
      min-height: 36px; border: 1px dashed var(--border-default); border-radius: var(--radius-sm);
      display: flex; align-items: center; padding: 4px 6px;
      transition: all var(--transition-fast); font-size: 0.7rem; color: var(--text-muted);
    }
    .tuesday-drop.drag-over { border-color: var(--gold); background: var(--gold-glow); border-style: solid; }
    .tuesday-drop.has-show { border-style: solid; border-color: var(--border-subtle); background: var(--bg-surface); cursor: pointer; }
    .tuesday-drop .show-info { display: flex; align-items: center; gap: 4px; width: 100%; }
    .tuesday-drop .ep-num { font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; color: var(--gold); font-weight: 600; }
    .tuesday-drop .show-title { font-size: 0.65rem; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
    .tuesday-drop .unassign-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.7rem; padding: 0 2px; opacity: 0; transition: opacity var(--transition-fast); }
    .tuesday-drop:hover .unassign-btn { opacity: 1; }
    .tuesday-drop .unassign-btn:hover { color: var(--danger); }
    .empty-placeholder { font-size: 0.6rem; color: var(--text-muted); opacity: 0.5; }
    .launch-badge { font-size: 0.55rem; background: var(--gold); color: var(--bg-deep); padding: 1px 5px; border-radius: 3px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .processing-overlay {
      position: absolute; inset: 0; background: rgba(8,8,15,0.85);
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: var(--space-md);
      border-radius: var(--radius-lg); z-index: 10;
    }
    .processing-overlay .spinner-lg { width: 40px; height: 40px; }
    .processing-text { color: var(--text-gold); font-family: 'Cinzel', serif; font-size: 0.9rem; }

    /* Edit mode */
    .edit-mode-banner {
      display: flex; justify-content: space-between; align-items: center; gap: var(--space-md);
      padding: var(--space-sm) var(--space-md); margin-bottom: var(--space-md);
      background: var(--gold-glow); border: 1px solid var(--gold-dim); border-radius: var(--radius-md);
      font-size: 0.8rem; color: var(--text-gold);
    }
    .edit-field {
      width: 100%; padding: 8px 10px; background: var(--bg-surface);
      border: 1px solid var(--border-default); border-radius: var(--radius-sm);
      color: var(--text-primary); font-family: 'DM Sans', sans-serif; font-size: 0.85rem;
      resize: vertical;
    }
    .edit-field:focus { border-color: var(--gold-dim); outline: none; }
    .edit-field-sm { padding: 5px 8px; font-size: 0.8rem; }
    .edit-title-row { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
    .edit-tp-row { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
    .add-tp-btn {
      display: inline-block; font-size: 0.75rem; color: var(--ice); cursor: pointer;
      padding: 3px 8px; border: 1px dashed var(--border-default); border-radius: var(--radius-sm);
      background: none; margin-top: 4px;
    }
    .add-tp-btn:hover { border-color: var(--ice); background: rgba(100,200,255,0.05); }

    /* Schedule date badges on idea cards */
    .schedule-info {
      display: flex; gap: var(--space-sm); align-items: center; flex-wrap: wrap;
      font-size: 0.75rem; margin-top: 4px;
    }
    .schedule-info .date-badge {
      display: inline-flex; align-items: center; gap: 3px;
      padding: 2px 8px; border-radius: 3px; font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem; font-weight: 600;
    }
    .date-badge.record { background: rgba(100,200,255,0.1); color: var(--ice); border: 1px solid rgba(100,200,255,0.2); }
    .date-badge.release { background: rgba(100,255,150,0.1); color: var(--status-scheduled); border: 1px solid rgba(100,255,150,0.2); }
    .date-badge.ep { background: rgba(200,168,78,0.1); color: var(--gold); border: 1px solid rgba(200,168,78,0.2); }

    /* Past episodes collapsible section */
    .past-section { margin-top: var(--space-lg); }
    .past-section-header {
      display: flex; align-items: center; gap: var(--space-sm);
      cursor: pointer; padding: var(--space-sm) var(--space-md);
      background: var(--bg-surface); border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md); margin-bottom: var(--space-md);
      user-select: none;
    }
    .past-section-header:hover { border-color: var(--border-default); }
    .past-section-header .chevron { transition: transform 0.2s; font-size: 0.8rem; color: var(--text-muted); }
    .past-section-header.open .chevron { transform: rotate(90deg); }
    .past-section-header h3 { font-size: 0.9rem; color: var(--text-muted); }
    .past-section-header .count { font-size: 0.75rem; color: var(--text-muted); }
    .past-section-content { display: none; }
    .past-section-content.open { display: flex; flex-direction: column; gap: var(--space-md); }

    /* Show display link */
    .show-display-link {
      display: inline-flex; align-items: center; gap: 3px;
      font-size: 0.7rem; color: var(--ice); text-decoration: none;
      padding: 2px 6px; border-radius: 3px;
      border: 1px solid transparent;
    }
    .show-display-link:hover { border-color: var(--ice); background: rgba(100,200,255,0.05); }

    /* Calendar show display link */
    .cal-display-link {
      font-size: 0.55rem; color: var(--ice); text-decoration: none; opacity: 0.7;
    }
    .cal-display-link:hover { opacity: 1; text-decoration: underline; }

    /* ===== Full-Screen Show Display ===== */
    .show-display-overlay {
      position: fixed; inset: 0; z-index: 99999;
      background: var(--bg-deep);
      overflow-y: auto;
      display: none;
    }
    .show-display-overlay.active { display: block; }
    .show-display-container {
      max-width: 100%; min-height: 100vh;
      padding: var(--space-xl) var(--space-lg);
    }
    .show-display-header {
      display: flex; justify-content: space-between; align-items: flex-start;
      margin-bottom: var(--space-xl);
      padding-bottom: var(--space-lg);
      border-bottom: 2px solid var(--gold-dim);
    }
    .show-display-header .ep-badge {
      font-family: 'JetBrains Mono', monospace; font-size: 1rem;
      color: var(--gold); font-weight: 700;
    }
    .show-display-header .dates {
      font-size: 0.85rem; color: var(--text-muted); margin-top: var(--space-xs);
    }
    .show-display-header h1 {
      font-family: 'Cinzel', serif; font-size: 2rem; color: var(--text-gold);
      margin: var(--space-sm) 0;
    }
    .show-display-close {
      background: var(--bg-surface); border: 1px solid var(--border-default);
      color: var(--text-primary); padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-md); cursor: pointer; font-size: 0.85rem;
      white-space: nowrap;
    }
    .show-display-close:hover { border-color: var(--gold-dim); }
    .show-display-section { margin-bottom: var(--space-xl); }
    .show-display-section h2 {
      font-family: 'Cinzel', serif; font-size: 1.1rem; color: var(--ice-bright);
      margin-bottom: var(--space-md); text-transform: uppercase; letter-spacing: 1px;
    }
    .show-display-section p, .show-display-section li {
      font-size: 1rem; line-height: 1.7; color: var(--text-secondary);
    }
    .show-display-section ul { list-style: none; padding-left: var(--space-lg); }
    .show-display-section li { position: relative; padding: var(--space-xs) 0; }
    .show-display-section li::before { content: '‚Ä∫'; position: absolute; left: -18px; color: var(--gold); font-weight: bold; font-size: 1.1rem; }
    .show-display-joke {
      padding: var(--space-md) var(--space-lg);
      background: var(--gold-glow); border: 1px solid var(--gold-dim);
      border-radius: var(--radius-md); font-size: 1rem; line-height: 1.6;
      color: var(--text-gold); font-style: italic;
    }
    .show-display-image {
      margin-top: var(--space-xl); text-align: center;
      padding-top: var(--space-lg); border-top: 1px solid var(--border-subtle);
    }
    .show-display-image img {
      max-width: 100%; border-radius: var(--radius-lg);
      border: 2px solid var(--border-subtle);
    }
    .show-display-next {
      margin-top: var(--space-xl); padding: var(--space-lg);
      background: var(--bg-surface); border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
    }
    .show-display-next h3 {
      font-family: 'Cinzel', serif; font-size: 0.9rem; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 1px; margin-bottom: var(--space-sm);
    }
    .show-display-next .next-title {
      font-size: 1.2rem; color: var(--text-gold); font-weight: 600;
    }
    .show-display-next .next-summary {
      font-size: 0.9rem; color: var(--text-secondary); margin-top: var(--space-xs); line-height: 1.5;
    }

    /* Image field in edit/view mode */
    .image-preview { margin-top: var(--space-sm); }
    .image-preview img {
      max-width: 300px; max-height: 200px; border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
    }

    /* Next show preview in idea card */
    .next-show-preview {
      margin-top: var(--space-md); padding: var(--space-md);
      background: var(--bg-surface); border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
    }
    .next-show-preview h4 {
      font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;
      letter-spacing: 0.5px; margin-bottom: var(--space-xs);
    }
    .next-show-preview .next-title { font-size: 0.85rem; color: var(--text-gold); }
    .next-show-preview .next-summary { font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px; }
  </style>
</head>
<body>

  <!-- ===== AUTH GATE ===== -->
  <div id="authGate">
    <div class="gate-box">
      <img src="images/256x256.jpeg" alt="SATT" class="gate-logo">
      <h2>Crew Only</h2>
      <p class="gate-sub">Enter the password to continue</p>
      <input type="password" id="gatePassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
      <button id="gateSubmit">Enter</button>
      <div class="gate-error" id="gateError"></div>
    </div>
  </div>

  <!-- ===== LOADING OVERLAY ===== -->
  <div id="loadingOverlay" style="display: none; position: fixed; inset: 0; z-index: 99998; background: #08080f; align-items: center; justify-content: center; flex-direction: column; gap: 16px;">
    <svg class="spinner-lg" viewBox="0 0 50 50" style="width:48px;height:48px;"><circle cx="25" cy="25" r="20" fill="none" stroke="#c8a84e" stroke-width="3" stroke-dasharray="80 40" stroke-linecap="round"><animateTransform attributeName="transform" type="rotate" values="0 25 25;360 25 25" dur="0.8s" repeatCount="indefinite"/></circle></svg>
    <span style="color: #c8a84e; font-family: 'Cinzel', serif; font-size: 0.9rem;">Loading show data...</span>
  </div>

  <!-- ===== FULL-SCREEN SHOW DISPLAY ===== -->
  <div class="show-display-overlay" id="showDisplayOverlay">
    <div class="show-display-container" id="showDisplayContent"></div>
  </div>

  <!-- ===== PROTECTED CONTENT ===== -->
  <div id="protectedContent" style="display: none;">

    <!-- Navigation -->
    <nav class="site-nav">
      <img src="images/256x256.jpeg" alt="SATT" class="nav-logo">
      <span class="nav-title">Salt All The Things</span>
      <div class="nav-spacer"></div>
      <a href="index.html">Home</a>
      <a href="show_management.html" class="active">Show Management</a>
      <a href="jokes.html">Joke Bank</a>
      <a href="config.html">Config</a>
      <button class="btn btn-ghost btn-sm" onclick="Auth.logout()" style="color: var(--text-muted);">üîí Logout</button>
    </nav>

    <div class="page-container">
      <div class="page-header">
        <h1>Show Management</h1>
        <p class="subtitle">Brainstorm ideas, let AI help shape them, then schedule your episodes</p>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="ideas" onclick="switchTab('ideas')">Ideas Workshop</button>
        <button class="tab" data-tab="schedule" onclick="switchTab('schedule')">Schedule Board</button>
      </div>

      <!-- ===== IDEAS WORKSHOP TAB ===== -->
      <div class="tab-content active" id="tab-ideas">
        <div class="ideas-grid">
          <div class="idea-composer">
            <div class="card card-elevated" style="position: relative;">
              <h2 class="mb-md">New Show Idea</h2>
              <p class="text-sm text-secondary mb-md">Dump your raw notes, thoughts, and topic ideas. Hit process and let AI turn it into a structured show outline.</p>
              <div class="form-group">
                <label>Rocket's Notes</label>
                <textarea id="ideaNotes" rows="12" placeholder="What's on your mind for this episode? Drop your ideas, rants, topics, hot takes... anything goes."></textarea>
              </div>
              <div class="flex gap-sm">
                <button class="btn btn-primary" onclick="processIdea()" id="processBtn">Save & Process with AI</button>
                <button class="btn btn-secondary" onclick="saveDraft()">Save as Draft</button>
              </div>
              <div id="composerOverlay" class="processing-overlay hidden">
                <div class="spinner-lg"></div>
                <div class="processing-text">AI is cooking...</div>
                <div class="text-sm text-secondary">Building your show outline</div>
              </div>
            </div>
          </div>

          <div>
            <div class="flex justify-between items-center mb-md">
              <h2>Show Ideas</h2>
              <span class="text-sm text-muted" id="ideaCount"></span>
            </div>
            <div class="ideas-list" id="ideasList"></div>
            <div id="pastEpisodesSection"></div>
            <div id="noIdeas" class="hidden" style="text-align: center; padding: 3rem 1rem;">
              <p class="text-secondary" style="font-size: 1.1rem;">No ideas yet</p>
              <p class="text-muted text-sm mt-sm">Write your first show idea in the composer</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== SCHEDULE BOARD TAB ===== -->
      <div class="tab-content" id="tab-schedule">
        <div class="schedule-layout">
          <div class="idea-bank">
            <div class="idea-bank-header">Idea Bank</div>
            <div class="bank-ideas" id="ideaBank"></div>
          </div>
          <div class="calendar-container">
            <div class="calendar-nav">
              <button class="btn btn-ghost btn-sm" onclick="changeMonth(-1)">‚Üê Prev</button>
              <h3 id="calendarTitle"></h3>
              <button class="btn btn-ghost btn-sm" onclick="changeMonth(1)">Next ‚Üí</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /protectedContent -->

  <script src="js/auth.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/ai-service.js"></script>
  <script src="js/show-engine.js"></script>
  <script src="js/toast.js"></script>
  <script>
    // Init auth gate
    Auth.init();

    // ============================================
    // State
    // ============================================
    let currentMonth = 1; // February
    let currentYear = 2026;
    let draggedIdeaId = null;
    const editingIdeas = new Set();
    let lastProcessedId = null;
    let pastSectionOpen = false;

    // ============================================
    // HTML Escaping
    // ============================================
    function esc(str) {
      if (str == null) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // ============================================
    // Tab Switching
    // ============================================
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
      if (tab === 'schedule') renderScheduleBoard();
    }

    // ============================================
    // Helper: Get schedule info for an idea
    // ============================================
    function getScheduleInfoForIdea(ideaId) {
      var assignments = Storage.getAssignments();
      var slots = Storage.getShowSlots();
      for (var slotId in assignments) {
        if (assignments[slotId] === ideaId) {
          var slot = slots.find(function(s) { return s.id === slotId; });
          if (slot) return slot;
        }
      }
      return null;
    }

    // ============================================
    // Helper: Get the "next show" (recorded 7 days after given date)
    // ============================================
    function getNextShowInfo(recordDate) {
      if (!recordDate) return null;
      var rd = new Date(recordDate + 'T00:00:00');
      rd.setDate(rd.getDate() + 7);
      var nextRecordDate = rd.getFullYear() + '-' + String(rd.getMonth()+1).padStart(2,'0') + '-' + String(rd.getDate()).padStart(2,'0');

      var slots = Storage.getShowSlots();
      var assignments = Storage.getAssignments();
      var ideas = Storage.getIdeas();

      var nextSlot = slots.find(function(s) { return s.recordDate === nextRecordDate; });
      if (!nextSlot) return null;

      var nextIdeaId = assignments[nextSlot.id];
      if (!nextIdeaId) return { slot: nextSlot, idea: null };

      var nextIdea = ideas.find(function(i) { return i.id === nextIdeaId; });
      return { slot: nextSlot, idea: nextIdea || null };
    }

    // ============================================
    // Helper: Google Drive image URL from file ID
    // ============================================
    function gdriveImageUrl(fileId) {
      if (!fileId) return '';
      return 'https://lh3.googleusercontent.com/d/' + fileId;
    }

    // ============================================
    // Ideas Workshop ‚Äî SORTED & SECTIONED
    // ============================================
    function renderIdeasList() {
      const ideas = Storage.getIdeas();
      const list = document.getElementById('ideasList');
      const pastSection = document.getElementById('pastEpisodesSection');
      const noIdeas = document.getElementById('noIdeas');
      const countEl = document.getElementById('ideaCount');
      countEl.textContent = ideas.length + ' idea' + (ideas.length !== 1 ? 's' : '');

      if (ideas.length === 0) {
        list.innerHTML = '';
        pastSection.innerHTML = '';
        noIdeas.classList.remove('hidden');
        return;
      }
      noIdeas.classList.add('hidden');

      var today = new Date().toISOString().split('T')[0];

      // Enrich ideas with schedule info
      var enriched = ideas.map(function(idea) {
        var slot = getScheduleInfoForIdea(idea.id);
        return { idea: idea, slot: slot };
      });

      // Split into three groups:
      // 1) Scheduled for today or future (by recording date ascending)
      // 2) Unscheduled (by lastModified/createdAt descending)
      // 3) Past episodes (recording date before today, by recording date descending)
      var futureScheduled = [];
      var unscheduled = [];
      var past = [];

      enriched.forEach(function(item) {
        if (item.slot) {
          if (item.slot.recordDate < today) {
            past.push(item);
          } else {
            futureScheduled.push(item);
          }
        } else {
          unscheduled.push(item);
        }
      });

      // Sort future: ascending by recording date
      futureScheduled.sort(function(a, b) {
        return a.slot.recordDate.localeCompare(b.slot.recordDate);
      });

      // Sort unscheduled: by lastModified or createdAt descending
      unscheduled.sort(function(a, b) {
        var aDate = a.idea.lastModified || a.idea.createdAt || '';
        var bDate = b.idea.lastModified || b.idea.createdAt || '';
        return bDate.localeCompare(aDate);
      });

      // Sort past: descending by recording date (most recent past first)
      past.sort(function(a, b) {
        return b.slot.recordDate.localeCompare(a.slot.recordDate);
      });

      // Render main list (future + unscheduled)
      var mainItems = futureScheduled.concat(unscheduled);
      list.innerHTML = mainItems.map(function(item) {
        return renderIdeaCard(item.idea, item.slot);
      }).join('');

      // Render past episodes section
      if (past.length > 0) {
        pastSection.innerHTML = '<div class="past-section">'
          + '<div class="past-section-header' + (pastSectionOpen ? ' open' : '') + '" onclick="togglePastSection()">'
          + '<span class="chevron">‚ñ∂</span>'
          + '<h3>Past Episodes</h3>'
          + '<span class="count">(' + past.length + ')</span>'
          + '</div>'
          + '<div class="past-section-content' + (pastSectionOpen ? ' open' : '') + '">'
          + past.map(function(item) { return renderIdeaCard(item.idea, item.slot); }).join('')
          + '</div></div>';
      } else {
        pastSection.innerHTML = '';
      }

      // Clear auto-expand flag
      if (lastProcessedId) lastProcessedId = null;
    }

    function togglePastSection() {
      pastSectionOpen = !pastSectionOpen;
      var header = document.querySelector('.past-section-header');
      var content = document.querySelector('.past-section-content');
      if (header) header.classList.toggle('open', pastSectionOpen);
      if (content) content.classList.toggle('open', pastSectionOpen);
    }

    function renderIdeaCard(idea, slot) {
      const title = esc(idea.selectedTitle || (idea.titles && idea.titles[0]) || 'Untitled Idea');
      const summary = esc(idea.summary || truncate(idea.rawNotes, 120));
      const isEditing = editingIdeas.has(idea.id);
      const autoExpand = (idea.id === lastProcessedId) || isEditing;

      // Schedule info line
      var scheduleHtml = '';
      if (slot) {
        scheduleHtml = '<div class="schedule-info">'
          + '<span class="date-badge ep">' + slot.episodeNumber + '</span>'
          + '<span class="date-badge record">Record: ' + ShowEngine.formatDateShort(slot.recordDate) + '</span>'
          + '<span class="date-badge release">Release: ' + ShowEngine.formatDateShort(slot.releaseDate) + '</span>'
          + '<a href="#show/' + slot.id + '" class="show-display-link" onclick="event.stopPropagation(); openShowDisplay(\'' + slot.id + '\'); return false;" title="Full show display">‚õ∂ View</a>'
          + '</div>';
      }

      return '<div class="idea-list-card' + (autoExpand ? ' expanded' : '') + '" id="idea-' + idea.id + '" onclick="toggleIdeaExpand(\'' + idea.id + '\')">'
        + '<div class="idea-header">'
        + '<div style="flex:1;">'
        + '<div class="flex items-center gap-sm mb-sm">'
        + '<span class="badge badge-' + idea.status + '">' + idea.status + '</span>'
        + (idea.selectedTitle ? '' : '<span class="text-xs text-muted">(no title selected)</span>')
        + '</div>'
        + '<h3 style="font-size: 1rem; color: var(--text-gold);">' + title + '</h3>'
        + scheduleHtml
        + '<p class="text-sm text-secondary mt-sm" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">' + summary + '</p>'
        + '<p class="text-xs text-muted mt-sm">' + formatTimestamp(idea.createdAt) + '</p>'
        + '</div>'
        + '<div class="flex gap-xs" onclick="event.stopPropagation()">'
        + (idea.status === 'draft' ? '<button class="btn btn-secondary btn-sm" onclick="reprocessIdea(\'' + idea.id + '\')">Process</button>' : '')
        + '<button class="btn btn-ghost btn-sm" onclick="deleteIdea(\'' + idea.id + '\')">‚úï</button>'
        + '</div>'
        + '</div>'
        + '<div class="idea-expanded-content" id="expanded-' + idea.id + '">'
        + ((idea.status === 'processed' || idea.status === 'scheduled') ? renderProcessedContent(idea, isEditing) : renderDraftContent(idea))
        + '</div>'
        + '</div>';
    }

    function renderProcessedContent(idea, isEditing) {
      // Joke picker
      var assignedJoke = Storage.getJokeForIdea(idea.id);
      var unusedJokes = Storage.getUnusedJokes();
      var jokeHtml = '';

      if (assignedJoke) {
        jokeHtml = '<div style="padding: 10px 14px; background: var(--gold-glow); border: 1px solid var(--gold-dim); border-radius: var(--radius-md); display: flex; align-items: flex-start; gap: var(--space-sm);">'
          + '<span style="font-size: 0.85rem; flex: 1; line-height: 1.5;">' + esc(assignedJoke.text) + '</span>'
          + '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); clearJokeFromIdea(\'' + idea.id + '\', \'' + assignedJoke.id + '\')" title="Remove joke" style="flex-shrink:0;">‚úï</button>'
          + '</div>';
      } else if (unusedJokes.length > 0) {
        jokeHtml = '<div class="flex flex-col gap-xs" style="max-height: 200px; overflow-y: auto;">';
        unusedJokes.forEach(function(j) {
          jokeHtml += '<div class="title-option" onclick="event.stopPropagation(); selectJokeForIdea(\'' + idea.id + '\', \'' + j.id + '\')" style="cursor:pointer;">'
            + '<span style="font-size: 0.8rem; line-height: 1.4;">' + esc(j.text) + '</span></div>';
        });
        jokeHtml += '</div><p class="text-xs text-muted mt-sm">Or <a href="jokes.html" style="color: var(--ice);">add more jokes</a> in the Joke Bank</p>';
      } else {
        jokeHtml = '<p class="text-sm text-muted">No unused jokes available. <a href="jokes.html" style="color: var(--ice);">Build your joke bank</a> first.</p>';
      }

      if (isEditing) {
        return renderEditMode(idea, jokeHtml);
      }
      return renderViewMode(idea, jokeHtml);
    }

    function renderViewMode(idea, jokeHtml) {
      var html = '';

      // Edit button
      html += '<div style="display:flex; justify-content:flex-end; margin-bottom: var(--space-sm);">'
        + '<button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); enterEditMode(\'' + idea.id + '\')">‚úèÔ∏è Edit</button>'
        + '</div>';

      // Title options
      html += '<div class="mb-md">'
        + '<label class="text-xs text-muted" style="display:block; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Title Options (click to select)</label>'
        + '<div class="flex flex-col gap-xs">';
      (idea.titles || []).forEach(function(t, i) {
        html += '<div class="title-option' + (idea.selectedTitle === t ? ' selected' : '') + '" onclick="event.stopPropagation(); selectTitle(\'' + idea.id + '\', ' + i + ')">'
          + '<input type="radio" name="title-' + idea.id + '"' + (idea.selectedTitle === t ? ' checked' : '') + '>'
          + '<span style="font-size: 0.85rem;">' + esc(t) + '</span></div>';
      });
      html += '</div></div>';

      // Joke picker
      var assignedJoke = Storage.getJokeForIdea(idea.id);
      html += '<div class="mb-md">'
        + '<label class="text-xs text-muted" style="display:block; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Opening Salt Joke ' + (assignedJoke ? '‚úì' : '(click to assign)') + '</label>'
        + jokeHtml + '</div>';

      // Summary
      html += '<div class="mb-md">'
        + '<label class="text-xs text-muted" style="display:block; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Summary</label>'
        + '<p class="text-sm" style="line-height: 1.6;">' + esc(idea.summary) + '</p></div>';

      // Outline
      html += '<div>'
        + '<label class="text-xs text-muted" style="display:block; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Show Outline</label>';
      (idea.outline || []).forEach(function(seg) {
        html += '<div class="outline-segment"><h4>' + esc(seg.segmentName) + '</h4><ul>';
        (seg.talkingPoints || []).forEach(function(tp) {
          html += '<li>' + esc(tp) + '</li>';
        });
        html += '</ul></div>';
      });
      html += '</div>';

      // Show Image
      if (idea.imageFileId) {
        html += '<div class="image-preview mt-md" style="padding-top: var(--space-md); border-top: 1px solid var(--border-subtle);">'
          + '<label class="text-xs text-muted" style="display:block; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Show Image</label>'
          + '<img src="' + gdriveImageUrl(idea.imageFileId) + '" alt="Show image" onerror="this.style.display=\'none\'">'
          + '</div>';
      }

      // Raw notes
      html += '<div class="mt-md" style="padding-top: var(--space-md); border-top: 1px solid var(--border-subtle);">'
        + '<details><summary class="text-xs text-muted" style="cursor: pointer;">Raw Notes</summary>'
        + '<pre class="text-sm mt-sm" style="white-space: pre-wrap; color: var(--text-secondary); font-family: \'DM Sans\', sans-serif; line-height: 1.6;">' + esc(idea.rawNotes) + '</pre>'
        + '</details></div>';

      // Next show preview
      var slot = getScheduleInfoForIdea(idea.id);
      if (slot) {
        html += renderNextShowPreview(slot.recordDate);
      }

      return html;
    }

    function renderEditMode(idea, jokeHtml) {
      var html = '';

      // Edit mode banner
      html += '<div class="edit-mode-banner" onclick="event.stopPropagation()">'
        + '<span>‚úèÔ∏è Edit Mode ‚Äî change anything, then save</span>'
        + '<div class="flex gap-xs">'
        + '<button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); saveEdits(\'' + idea.id + '\')">Save Changes</button>'
        + '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); cancelEdit(\'' + idea.id + '\')">Cancel</button>'
        + '</div></div>';

      // Editable titles
      html += '<div class="mb-md" onclick="event.stopPropagation()">'
        + '<label class="text-xs text-muted" style="display:block; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Title Options (edit or add)</label>';
      (idea.titles || []).forEach(function(t, i) {
        html += '<div class="edit-title-row">'
          + '<input type="radio" name="edit-title-' + idea.id + '" value="' + i + '"' + (idea.selectedTitle === t ? ' checked' : '') + ' style="accent-color: var(--gold);">'
          + '<input type="text" class="edit-field edit-field-sm" data-edit-title="' + i + '" value="' + esc(t) + '">'
          + '<button class="btn btn-ghost btn-sm" onclick="removeEditTitle(this)" title="Remove">‚úï</button>'
          + '</div>';
      });
      html += '<button class="add-tp-btn" onclick="addEditTitle(\'' + idea.id + '\')">+ Add Title</button>'
        + '</div>';

      // Joke picker (same as view mode)
      var assignedJoke = Storage.getJokeForIdea(idea.id);
      html += '<div class="mb-md">'
        + '<label class="text-xs text-muted" style="display:block; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Opening Salt Joke ' + (assignedJoke ? '‚úì' : '(click to assign)') + '</label>'
        + jokeHtml + '</div>';

      // Editable summary
      html += '<div class="mb-md" onclick="event.stopPropagation()">'
        + '<label class="text-xs text-muted" style="display:block; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Summary</label>'
        + '<textarea class="edit-field" data-edit-summary rows="3">' + esc(idea.summary || '') + '</textarea></div>';

      // Editable outline
      html += '<div onclick="event.stopPropagation()">'
        + '<label class="text-xs text-muted" style="display:block; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Show Outline</label>';
      (idea.outline || []).forEach(function(seg, si) {
        html += '<div class="outline-segment" data-seg-index="' + si + '">'
          + '<div style="display:flex; align-items:center; gap:6px; margin-bottom:6px;">'
          + '<input type="text" class="edit-field edit-field-sm" data-edit-seg-name="' + si + '" value="' + esc(seg.segmentName) + '" style="font-weight:600; color: var(--ice-bright);">'
          + '</div>';
        (seg.talkingPoints || []).forEach(function(tp, ti) {
          html += '<div class="edit-tp-row">'
            + '<span style="color: var(--gold-dim); font-weight: bold; font-size: 0.8rem;">‚Ä∫</span>'
            + '<input type="text" class="edit-field edit-field-sm" data-edit-tp="' + si + '-' + ti + '" value="' + esc(tp) + '">'
            + '<button class="btn btn-ghost btn-sm" onclick="this.parentElement.remove()" title="Remove" style="font-size:0.7rem;">‚úï</button>'
            + '</div>';
        });
        html += '<button class="add-tp-btn" onclick="addTalkingPoint(this, ' + si + ')">+ Add Point</button>'
          + '</div>';
      });
      html += '</div>';

      // Image File ID (editable)
      html += '<div class="mt-md" onclick="event.stopPropagation()" style="padding-top: var(--space-md); border-top: 1px solid var(--border-subtle);">'
        + '<label class="text-xs text-muted" style="display:block; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Show Image (Google Drive File ID)</label>'
        + '<input type="text" class="edit-field edit-field-sm" data-edit-image-id value="' + esc(idea.imageFileId || '') + '" placeholder="Paste Google Drive file ID here...">'
        + '<p class="text-xs text-muted mt-sm">Share the image as "Anyone with the link" then paste just the file ID from the URL.</p>';
      if (idea.imageFileId) {
        html += '<div class="image-preview mt-sm"><img src="' + gdriveImageUrl(idea.imageFileId) + '" alt="Preview" onerror="this.style.display=\'none\'"></div>';
      }
      html += '</div>';

      // Raw notes (editable)
      html += '<div class="mt-md" style="padding-top: var(--space-md); border-top: 1px solid var(--border-subtle);" onclick="event.stopPropagation()">'
        + '<label class="text-xs text-muted" style="display:block; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Raw Notes</label>'
        + '<textarea class="edit-field" data-edit-rawnotes rows="8" style="font-size:0.8rem;">' + esc(idea.rawNotes || '') + '</textarea>'
        + '</div>';

      // Next show preview
      var slot = getScheduleInfoForIdea(idea.id);
      if (slot) {
        html += renderNextShowPreview(slot.recordDate);
      }

      return html;
    }

    function renderDraftContent(idea) {
      return '<div>'
        + '<label class="text-xs text-muted" style="display:block; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Raw Notes</label>'
        + '<pre class="text-sm" style="white-space: pre-wrap; color: var(--text-secondary); font-family: \'DM Sans\', sans-serif; line-height: 1.6;">' + esc(idea.rawNotes) + '</pre>'
        + '</div>';
    }

    // ============================================
    // Next Show Preview
    // ============================================
    function renderNextShowPreview(recordDate) {
      var next = getNextShowInfo(recordDate);
      if (!next) return '';

      var html = '<div class="next-show-preview">'
        + '<h4>Next Recording (' + ShowEngine.formatDateShort(next.slot.recordDate) + ')</h4>';

      if (next.idea) {
        var nextTitle = next.idea.selectedTitle || (next.idea.titles && next.idea.titles[0]) || 'Untitled';
        html += '<div class="next-title">' + esc(nextTitle) + '</div>';
        if (next.idea.summary) {
          html += '<div class="next-summary">' + esc(next.idea.summary) + '</div>';
        }
      } else {
        html += '<div class="next-title" style="color: var(--text-muted); font-style: italic;">No show scheduled</div>';
      }

      html += '</div>';
      return html;
    }

    // ============================================
    // Edit Mode Functions
    // ============================================
    function enterEditMode(ideaId) {
      editingIdeas.add(ideaId);
      renderIdeasList();
      var card = document.getElementById('idea-' + ideaId);
      if (card && !card.classList.contains('expanded')) card.classList.add('expanded');
    }

    function cancelEdit(ideaId) {
      editingIdeas.delete(ideaId);
      renderIdeasList();
      var card = document.getElementById('idea-' + ideaId);
      if (card && !card.classList.contains('expanded')) card.classList.add('expanded');
    }

    function saveEdits(ideaId) {
      var container = document.getElementById('expanded-' + ideaId);
      if (!container) return;

      // Gather titles
      var titleInputs = container.querySelectorAll('[data-edit-title]');
      var titles = [];
      titleInputs.forEach(function(inp) { var v = inp.value.trim(); if (v) titles.push(v); });

      // Which title is selected
      var selectedRadio = container.querySelector('input[name="edit-title-' + ideaId + '"]:checked');
      var selectedIdx = selectedRadio ? parseInt(selectedRadio.value) : 0;
      var selectedTitle = titles[selectedIdx] || titles[0] || '';

      // Summary
      var summaryEl = container.querySelector('[data-edit-summary]');
      var summary = summaryEl ? summaryEl.value.trim() : '';

      // Outline
      var segEls = container.querySelectorAll('[data-seg-index]');
      var outline = [];
      segEls.forEach(function(segEl) {
        var si = segEl.dataset.segIndex;
        var nameEl = segEl.querySelector('[data-edit-seg-name="' + si + '"]');
        var segName = nameEl ? nameEl.value.trim() : '';
        var tpInputs = segEl.querySelectorAll('[data-edit-tp]');
        var talkingPoints = [];
        tpInputs.forEach(function(tpInp) { var v = tpInp.value.trim(); if (v) talkingPoints.push(v); });
        if (segName) outline.push({ segmentId: segName.toLowerCase().replace(/[^a-z0-9]/g, '_').substring(0, 20), segmentName: segName, talkingPoints: talkingPoints });
      });

      // Raw notes
      var rawEl = container.querySelector('[data-edit-rawnotes]');
      var rawNotes = rawEl ? rawEl.value : '';

      // Image file ID
      var imageEl = container.querySelector('[data-edit-image-id]');
      var imageFileId = imageEl ? imageEl.value.trim() : '';

      Storage.updateIdea(ideaId, {
        titles: titles,
        selectedTitle: selectedTitle,
        summary: summary,
        outline: outline,
        rawNotes: rawNotes,
        imageFileId: imageFileId || null,
        lastModified: new Date().toISOString()
      });

      editingIdeas.delete(ideaId);
      renderIdeasList();
      var card = document.getElementById('idea-' + ideaId);
      if (card && !card.classList.contains('expanded')) card.classList.add('expanded');
      Toast.success('Changes saved!');
    }

    function addEditTitle(ideaId) {
      var container = document.getElementById('expanded-' + ideaId);
      var addBtn = container.querySelector('.add-tp-btn');
      var titlesParent = addBtn.parentElement;
      var count = titlesParent.querySelectorAll('.edit-title-row').length;
      var row = document.createElement('div');
      row.className = 'edit-title-row';
      row.innerHTML = '<input type="radio" name="edit-title-' + ideaId + '" value="' + count + '" style="accent-color: var(--gold);">'
        + '<input type="text" class="edit-field edit-field-sm" data-edit-title="' + count + '" value="" placeholder="New title...">'
        + '<button class="btn btn-ghost btn-sm" onclick="this.parentElement.remove()" title="Remove">‚úï</button>';
      titlesParent.insertBefore(row, addBtn);
      row.querySelector('input[type="text"]').focus();
    }

    function removeEditTitle(btn) {
      btn.parentElement.remove();
    }

    function addTalkingPoint(btn, segIndex) {
      var row = document.createElement('div');
      row.className = 'edit-tp-row';
      var idx = btn.parentElement.querySelectorAll('.edit-tp-row').length;
      row.innerHTML = '<span style="color: var(--gold-dim); font-weight: bold; font-size: 0.8rem;">‚Ä∫</span>'
        + '<input type="text" class="edit-field edit-field-sm" data-edit-tp="' + segIndex + '-' + idx + '" value="" placeholder="New talking point...">'
        + '<button class="btn btn-ghost btn-sm" onclick="this.parentElement.remove()" title="Remove" style="font-size:0.7rem;">‚úï</button>';
      btn.parentElement.insertBefore(row, btn);
      row.querySelector('input[type="text"]').focus();
    }

    // ============================================
    // Idea Actions
    // ============================================
    function toggleIdeaExpand(ideaId) { document.getElementById('idea-' + ideaId).classList.toggle('expanded'); }

    function selectTitle(ideaId, titleIndex) {
      var ideas = Storage.getIdeas();
      var idea = ideas.find(function(i) { return i.id === ideaId; });
      if (idea && idea.titles) { Storage.updateIdea(ideaId, { selectedTitle: idea.titles[titleIndex] }); renderIdeasList(); }
    }

    function selectJokeForIdea(ideaId, jokeId) {
      Storage.freeJokesForIdea(ideaId);
      Storage.markJokeUsed(jokeId, ideaId);
      renderIdeasList();
      Toast.success('Joke assigned to show!');
    }

    function clearJokeFromIdea(ideaId, jokeId) {
      Storage.markJokeUnused(jokeId);
      renderIdeasList();
      Toast.info('Joke freed up.');
    }

    async function processIdea() {
      var notes = document.getElementById('ideaNotes').value.trim();
      if (!notes) { Toast.error('Write some notes first!'); return; }
      var config = Storage.getConfig();
      if (config.aiModel === 'claude' && !config.claudeApiKey) { Toast.error('Claude API key not set. Go to Config.'); return; }
      if (config.aiModel === 'openai' && !config.openaiApiKey) { Toast.error('OpenAI API key not set. Go to Config.'); return; }
      document.getElementById('composerOverlay').classList.remove('hidden');
      document.getElementById('processBtn').disabled = true;
      try {
        var result = await AIService.processIdea(notes);
        var newId = Storage.generateId();
        var idea = {
          id: newId, rawNotes: notes, titles: result.titles,
          selectedTitle: result.titles[0], summary: result.summary, outline: result.outline,
          status: 'processed', aiModel: config.aiModel, createdAt: new Date().toISOString(),
          imageFileId: null
        };
        Storage.addIdea(idea);
        document.getElementById('ideaNotes').value = '';
        lastProcessedId = newId;
        editingIdeas.add(newId);
        renderIdeasList();
        Toast.success('Idea processed! Review and edit below.');
      } catch (err) { console.error('Process error:', err); Toast.error('AI processing failed: ' + err.message); }
      finally { document.getElementById('composerOverlay').classList.add('hidden'); document.getElementById('processBtn').disabled = false; }
    }

    function saveDraft() {
      var notes = document.getElementById('ideaNotes').value.trim();
      if (!notes) { Toast.error('Write some notes first!'); return; }
      Storage.addIdea({
        id: Storage.generateId(), rawNotes: notes, titles: [], selectedTitle: null,
        summary: null, outline: [], status: 'draft', aiModel: null, createdAt: new Date().toISOString(),
        imageFileId: null
      });
      document.getElementById('ideaNotes').value = '';
      renderIdeasList();
      Toast.success('Draft saved!');
    }

    async function reprocessIdea(ideaId) {
      var idea = Storage.getIdeas().find(function(i) { return i.id === ideaId; });
      if (!idea) return;
      var config = Storage.getConfig();
      if (config.aiModel === 'claude' && !config.claudeApiKey) { Toast.error('Claude API key not set.'); return; }
      if (config.aiModel === 'openai' && !config.openaiApiKey) { Toast.error('OpenAI API key not set.'); return; }
      Toast.info('Processing idea with AI...');
      try {
        var result = await AIService.processIdea(idea.rawNotes);
        Storage.updateIdea(ideaId, { titles: result.titles, selectedTitle: result.titles[0], summary: result.summary, outline: result.outline, status: 'processed', aiModel: config.aiModel });
        lastProcessedId = ideaId;
        editingIdeas.add(ideaId);
        renderIdeasList();
        Toast.success('Idea processed! Review and edit below.');
      } catch (err) { Toast.error('Processing failed: ' + err.message); }
    }

    function deleteIdea(ideaId) {
      if (!confirm('Delete this idea?')) return;
      var slotId = Storage.getSlotForIdea(ideaId);
      if (slotId) Storage.unassignSlot(slotId);
      Storage.freeJokesForIdea(ideaId);
      Storage.deleteIdea(ideaId);
      editingIdeas.delete(ideaId);
      renderIdeasList();
      Toast.info('Idea deleted.');
    }

    // ============================================
    // Full-Screen Show Display
    // ============================================
    function openShowDisplay(slotId) {
      var slots = Storage.getShowSlots();
      var assignments = Storage.getAssignments();
      var ideas = Storage.getIdeas();

      var slot = slots.find(function(s) { return s.id === slotId; });
      if (!slot) { Toast.error('Show slot not found.'); return; }

      var ideaId = assignments[slotId];
      var idea = ideaId ? ideas.find(function(i) { return i.id === ideaId; }) : null;

      if (!idea) { Toast.error('No idea assigned to this slot.'); return; }

      // Update URL hash
      history.pushState(null, '', '#show/' + slotId);

      var title = idea.selectedTitle || (idea.titles && idea.titles[0]) || 'Untitled';
      var assignedJoke = Storage.getJokeForIdea(idea.id);

      var html = '<div class="show-display-header">'
        + '<div>'
        + '<span class="ep-badge">' + slot.episodeNumber + '</span>'
        + '<h1>' + esc(title) + '</h1>'
        + '<div class="dates">Record: ' + ShowEngine.formatDateShort(slot.recordDate) + ' &nbsp;|&nbsp; Release: ' + ShowEngine.formatDateShort(slot.releaseDate) + '</div>'
        + '</div>'
        + '<button class="show-display-close" onclick="closeShowDisplay()">‚úï Close</button>'
        + '</div>';

      // Opening joke
      if (assignedJoke) {
        html += '<div class="show-display-section">'
          + '<h2>Opening Salt Joke</h2>'
          + '<div class="show-display-joke">' + esc(assignedJoke.text) + '</div>'
          + '</div>';
      }

      // Summary
      if (idea.summary) {
        html += '<div class="show-display-section">'
          + '<h2>Summary</h2>'
          + '<p>' + esc(idea.summary) + '</p>'
          + '</div>';
      }

      // Outline
      if (idea.outline && idea.outline.length > 0) {
        html += '<div class="show-display-section">'
          + '<h2>Show Outline</h2>';
        idea.outline.forEach(function(seg) {
          html += '<div style="margin-bottom: 1.5rem;">'
            + '<h3 style="font-size: 1rem; color: var(--ice-bright); margin-bottom: 0.5rem;">' + esc(seg.segmentName) + '</h3>'
            + '<ul>';
          (seg.talkingPoints || []).forEach(function(tp) {
            html += '<li>' + esc(tp) + '</li>';
          });
          html += '</ul></div>';
        });
        html += '</div>';
      }

      // Raw notes
      if (idea.rawNotes) {
        html += '<div class="show-display-section">'
          + '<h2>Raw Notes</h2>'
          + '<p style="white-space: pre-wrap;">' + esc(idea.rawNotes) + '</p>'
          + '</div>';
      }

      // Next show preview
      var next = getNextShowInfo(slot.recordDate);
      if (next) {
        html += '<div class="show-display-next">'
          + '<h3>Next Recording (' + ShowEngine.formatDateShort(next.slot.recordDate) + ')</h3>';
        if (next.idea) {
          var nextTitle = next.idea.selectedTitle || (next.idea.titles && next.idea.titles[0]) || 'Untitled';
          html += '<div class="next-title">' + esc(nextTitle) + '</div>';
          if (next.idea.summary) {
            html += '<div class="next-summary">' + esc(next.idea.summary) + '</div>';
          }
        } else {
          html += '<div class="next-title" style="color: var(--text-muted); font-style: italic;">No show scheduled</div>';
        }
        html += '</div>';
      }

      // Show image (at the very bottom)
      if (idea.imageFileId) {
        html += '<div class="show-display-image">'
          + '<img src="' + gdriveImageUrl(idea.imageFileId) + '" alt="Show image for ' + esc(title) + '" onerror="this.parentElement.style.display=\'none\'">'
          + '</div>';
      }

      document.getElementById('showDisplayContent').innerHTML = html;
      document.getElementById('showDisplayOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeShowDisplay() {
      document.getElementById('showDisplayOverlay').classList.remove('active');
      document.body.style.overflow = '';
      // Clean URL hash
      if (location.hash.startsWith('#show/')) {
        history.pushState(null, '', location.pathname + location.search);
      }
    }

    // Handle back button and hash navigation
    window.addEventListener('hashchange', function() {
      if (location.hash.startsWith('#show/')) {
        var slotId = location.hash.replace('#show/', '');
        openShowDisplay(slotId);
      } else {
        closeShowDisplay();
      }
    });

    // ============================================
    // Schedule Board
    // ============================================
    function renderScheduleBoard() { ShowEngine.ensureSlots(); renderIdeaBank(); renderCalendar(); }

    function renderIdeaBank() {
      var ideas = Storage.getIdeas();
      var assignments = Storage.getAssignments();
      var assignedIdeaIds = new Set(Object.values(assignments));
      var available = ideas.filter(function(i) { return (i.status === 'processed' || i.status === 'scheduled') && !assignedIdeaIds.has(i.id); });
      var container = document.getElementById('ideaBank');
      if (available.length === 0) { container.innerHTML = '<div class="bank-empty">No unscheduled ideas.<br>Process ideas in the Workshop first.</div>'; return; }
      container.innerHTML = available.map(function(idea) {
        return '<div class="idea-card" draggable="true" data-idea-id="' + idea.id + '"'
          + ' ondragstart="onDragStart(event, \'' + idea.id + '\')" ondragend="onDragEnd(event)">'
          + '<div class="idea-title">' + esc(idea.selectedTitle || (idea.titles && idea.titles[0]) || 'Untitled') + '</div>'
          + '<div class="idea-summary">' + esc(idea.summary || truncate(idea.rawNotes, 80)) + '</div>'
          + '</div>';
      }).join('');
    }

    function renderCalendar() {
      var grid = document.getElementById('calendarGrid');
      var titleEl = document.getElementById('calendarTitle');
      var monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      titleEl.textContent = monthNames[currentMonth] + ' ' + currentYear;
      var days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      var html = days.map(function(d) { return '<div class="calendar-header-cell' + (d === 'Tue' ? ' tuesday' : '') + '">' + d + '</div>'; }).join('');
      var firstDay = new Date(currentYear, currentMonth, 1);
      var lastDay = new Date(currentYear, currentMonth + 1, 0);
      var startPad = firstDay.getDay();
      var today = new Date().toISOString().split('T')[0];
      var prevMonthLast = new Date(currentYear, currentMonth, 0);
      for (var i = startPad - 1; i >= 0; i--) {
        var d = prevMonthLast.getDate() - i;
        var dateStr = formatDateStr(currentYear, currentMonth - 1, d);
        var dow = new Date(currentYear, currentMonth - 1, d).getDay();
        html += renderCalendarDay(d, dateStr, true, dow === 2, today);
      }
      for (var d = 1; d <= lastDay.getDate(); d++) {
        var dateStr = formatDateStr(currentYear, currentMonth, d);
        var dow = new Date(currentYear, currentMonth, d).getDay();
        html += renderCalendarDay(d, dateStr, false, dow === 2, today);
      }
      var totalCells = startPad + lastDay.getDate();
      var remaining = (7 - (totalCells % 7)) % 7;
      for (var d = 1; d <= remaining; d++) {
        var dateStr = formatDateStr(currentYear, currentMonth + 1, d);
        var dow = new Date(currentYear, currentMonth + 1, d).getDay();
        html += renderCalendarDay(d, dateStr, true, dow === 2, today);
      }
      grid.innerHTML = html;
    }

    function renderCalendarDay(dayNum, dateStr, isOtherMonth, isTuesday, today) {
      var isToday = dateStr === today;
      var classes = 'calendar-day';
      if (isOtherMonth) classes += ' other-month';
      if (isToday) classes += ' today';
      if (!isTuesday) return '<div class="' + classes + '"><span class="day-number">' + dayNum + '</span></div>';
      classes += ' tuesday';
      var slots = Storage.getShowSlots();
      var assignments = Storage.getAssignments();
      var ideas = Storage.getIdeas();
      var recordSlot = slots.find(function(s) { return s.recordDate === dateStr; });
      var publishSlots = slots.filter(function(s) { return s.releaseDate === dateStr; });
      var recordHtml = '';
      if (recordSlot) {
        var assignedIdeaId = assignments[recordSlot.id];
        if (assignedIdeaId) {
          var idea = ideas.find(function(i) { return i.id === assignedIdeaId; });
          recordHtml = '<div class="tuesday-drop has-show" data-slot-id="' + recordSlot.id + '" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event, \'' + recordSlot.id + '\')">'
            + '<div class="show-info"><span class="ep-num">' + recordSlot.episodeNumber + '</span><span class="show-title">' + esc(idea ? (idea.selectedTitle || (idea.titles && idea.titles[0]) || 'Untitled') : 'Untitled') + '</span>'
            + '<a href="#show/' + recordSlot.id + '" class="cal-display-link" onclick="event.stopPropagation(); openShowDisplay(\'' + recordSlot.id + '\'); return false;" title="View show">‚õ∂</a>'
            + '<button class="unassign-btn" onclick="event.stopPropagation(); unassignShow(\'' + recordSlot.id + '\')" title="Remove">‚úï</button></div></div>';
        } else {
          recordHtml = '<div class="tuesday-drop" data-slot-id="' + recordSlot.id + '" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event, \'' + recordSlot.id + '\')">'
            + '<span class="empty-placeholder">' + recordSlot.episodeNumber + ' ‚Äî drop idea</span></div>';
        }
      }
      var publishHtml = '';
      if (publishSlots.length > 0) {
        var isLaunch = publishSlots.some(function(s) { return s.isLaunchBatch; });
        publishHtml = publishSlots.map(function(ps) {
          var aid = assignments[ps.id];
          if (aid) {
            var idea = ideas.find(function(i) { return i.id === aid; });
            return '<div class="tuesday-drop has-show" style="border-left: 2px solid var(--status-scheduled);">'
              + '<div class="show-info"><span class="ep-num">' + ps.episodeNumber + '</span><span class="show-title">' + esc(idea ? (idea.selectedTitle || (idea.titles && idea.titles[0]) || 'Untitled') : 'Untitled') + '</span></div></div>';
          }
          return '<div class="tuesday-drop" style="border-left: 2px solid var(--status-scheduled); opacity: 0.5;"><span class="empty-placeholder">' + ps.episodeNumber + '</span></div>';
        }).join('');
        if (isLaunch) publishHtml = '<span class="launch-badge">Launch Day</span>' + publishHtml;
      }
      return '<div class="' + classes + '"><span class="day-number">' + dayNum + '</span><div class="tuesday-sections">'
        + (recordSlot ? '<div><div class="tuesday-section-label record">Record</div>' + recordHtml + '</div>' : '')
        + (publishSlots.length > 0 ? '<div><div class="tuesday-section-label publish">Publish</div>' + publishHtml + '</div>' : '')
        + '</div></div>';
    }

    function changeMonth(delta) {
      currentMonth += delta;
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      renderCalendar();
    }

    // ============================================
    // Drag & Drop
    // ============================================
    function onDragStart(e, ideaId) { draggedIdeaId = ideaId; e.target.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', ideaId); }
    function onDragEnd(e) { draggedIdeaId = null; e.target.classList.remove('dragging'); }
    function onDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; e.currentTarget.classList.add('drag-over'); }
    function onDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
    function onDrop(e, slotId) {
      e.preventDefault(); e.currentTarget.classList.remove('drag-over');
      var ideaId = e.dataTransfer.getData('text/plain') || draggedIdeaId;
      if (!ideaId || !slotId) return;
      var currentAssignment = Storage.getIdeaForSlot(slotId);
      if (currentAssignment) { if (!confirm('This slot already has an idea. Replace it?')) return; Storage.unassignSlot(slotId); }
      Storage.assignIdeaToSlot(ideaId, slotId);
      renderScheduleBoard(); renderIdeasList();
      var slot = ShowEngine.getSlotById(slotId);
      Toast.success('Assigned to ' + slot.episodeNumber + ' (record ' + ShowEngine.formatDateShort(slot.recordDate) + ')');
    }
    function unassignShow(slotId) { Storage.unassignSlot(slotId); renderScheduleBoard(); renderIdeasList(); Toast.info('Show unassigned.'); }

    // ============================================
    // Utilities
    // ============================================
    function truncate(str, len) { if (!str) return ''; return str.length > len ? str.substring(0, len) + '...' : str; }
    function formatTimestamp(iso) { if (!iso) return ''; var d = new Date(iso); return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) + ' at ' + d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }); }
    function formatDateStr(year, month, day) { var d = new Date(year, month, day); return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'); }

    // ============================================
    // Init ‚Äî called by Auth after Storage.init()
    // ============================================
    function onStorageReady() {
      ShowEngine.ensureSlots();
      renderIdeasList();

      // Check for hash-based show display on load
      if (location.hash.startsWith('#show/')) {
        var slotId = location.hash.replace('#show/', '');
        // Small delay to ensure data is ready
        setTimeout(function() { openShowDisplay(slotId); }, 100);
      }
    }

    // Close show display on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && document.getElementById('showDisplayOverlay').classList.contains('active')) {
        closeShowDisplay();
      }
    });
  </script>
</body>
</html>
